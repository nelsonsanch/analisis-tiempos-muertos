rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para obtener el perfil del usuario
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function para verificar si es super admin
    function isSuperAdmin() {
      return request.auth != null && getUserProfile().role == 'super_admin';
    }
    
    // Helper function para verificar si el usuario pertenece a la empresa
    function belongsToCompany(companyId) {
      return request.auth != null && getUserProfile().companyId == companyId;
    }
    
    // Helper function para verificar si la empresa del usuario está activa
    function isCompanyActive() {
      let profile = getUserProfile();
      if (!exists(/databases/$(database)/documents/companies/$(profile.companyId))) {
        return false;
      }
      let company = get(/databases/$(database)/documents/companies/$(profile.companyId)).data;
      return company.status == 'active';
    }
    
    // Colección de usuarios (perfiles)
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer su propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      // Solo el propio usuario o super admin pueden escribir
      allow write: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
    }
    
    // Colección de empresas
    match /companies/{companyId} {
      // Super admin puede leer y escribir todas las empresas
      allow read, write: if isSuperAdmin();
      // Usuarios de la empresa pueden leer su propia empresa
      allow read: if belongsToCompany(companyId);
    }
    
    // Colección de áreas de análisis (multi-tenant)
    match /timeAnalysisAreas/{areaId} {
      // Super admin NO puede acceder a datos de empresas
      // Usuarios solo pueden acceder a áreas de su empresa Y su empresa debe estar activa
      allow read: if request.auth != null && 
                     !isSuperAdmin() && 
                     belongsToCompany(resource.data.companyId) &&
                     isCompanyActive();
      
      allow create: if request.auth != null && 
                       !isSuperAdmin() && 
                       belongsToCompany(request.resource.data.companyId) &&
                       isCompanyActive();
      
      allow update, delete: if request.auth != null && 
                               !isSuperAdmin() && 
                               belongsToCompany(resource.data.companyId) &&
                               isCompanyActive();
    }
    
    // Colección de mediciones globales (multi-tenant)
    match /globalMeasurements/{measurementId} {
      // Super admin NO puede acceder a mediciones de empresas
      // Usuarios solo pueden acceder a mediciones de su empresa Y su empresa debe estar activa
      allow read: if request.auth != null && 
                     !isSuperAdmin() && 
                     belongsToCompany(resource.data.companyId) &&
                     isCompanyActive();
      
      allow create: if request.auth != null && 
                       !isSuperAdmin() && 
                       belongsToCompany(request.resource.data.companyId) &&
                       isCompanyActive();
      
      allow update, delete: if request.auth != null && 
                               !isSuperAdmin() && 
                               belongsToCompany(resource.data.companyId) &&
                               isCompanyActive();
    }
    
    // Colección de items globales de Tortuga (compartidos entre empresas)
    match /globalTurtleItems/{itemId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Colección de usuarios autorizados (legacy - mantener por compatibilidad)
    match /authorized_users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
