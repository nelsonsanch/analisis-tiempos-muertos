rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Obtener datos del usuario desde /users/{uid}
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function: Verificar si el usuario es super_admin
    function isSuperAdmin() {
      return request.auth != null && getUserData().role == 'super_admin';
    }
    
    // Helper function: Verificar si el usuario pertenece a una empresa
    function hasCompany() {
      return request.auth != null && 'companyId' in getUserData() && getUserData().companyId != null;
    }
    
    // Helper function: Obtener companyId del usuario
    function getUserCompanyId() {
      return getUserData().companyId;
    }
    
    // Colección de usuarios (perfiles)
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer su propio perfil
      allow read: if request.auth != null && request.auth.uid == userId;
      // Permitir crear perfil durante registro (userId debe coincidir con auth.uid)
      allow create: if request.auth != null && 
                       request.auth.uid == userId;
      // Solo el propio usuario puede actualizar su perfil
      allow update: if request.auth != null && request.auth.uid == userId;
      // Solo el propio usuario puede eliminar su perfil
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Colección de empresas
    match /companies/{companyId} {
      // Super admin puede leer todas las empresas
      // Usuarios regulares pueden leer solo su empresa
      allow read: if request.auth != null && 
                     (isSuperAdmin() || (hasCompany() && getUserCompanyId() == companyId));
      
      // Permitir crear empresa durante registro (cualquier usuario autenticado)
      allow create: if request.auth != null && 
                       request.resource.data.status == 'pending';
      
      // Solo super admin puede actualizar empresas
      allow update: if request.auth != null && isSuperAdmin();
      
      // Solo super admin puede eliminar empresas
      allow delete: if request.auth != null && isSuperAdmin();
    }

    // Colección de áreas de análisis (multi-tenant con aislamiento estricto)
    match /timeAnalysisAreas/{areaId} {
      // Solo usuarios con companyId pueden leer áreas de SU empresa
      // Super admin NO puede leer áreas (solo administra empresas)
      allow read: if request.auth != null && 
                     hasCompany() && 
                     resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden crear áreas
      // El área DEBE tener el mismo companyId que el usuario
      allow create: if request.auth != null && 
                       hasCompany() && 
                       request.resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden actualizar áreas de SU empresa
      // NO se puede cambiar el companyId
      allow update: if request.auth != null && 
                       hasCompany() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden eliminar áreas de SU empresa
      allow delete: if request.auth != null && 
                       hasCompany() && 
                       resource.data.companyId == getUserCompanyId();
    }

    // Colección de mediciones globales (multi-tenant con aislamiento estricto)
    match /globalMeasurements/{measurementId} {
      // Solo usuarios con companyId pueden leer mediciones de SU empresa
      allow read: if request.auth != null && 
                     hasCompany() && 
                     resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden crear mediciones
      // La medición DEBE tener el mismo companyId que el usuario
      allow create: if request.auth != null && 
                       hasCompany() && 
                       request.resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden actualizar mediciones de SU empresa
      allow update: if request.auth != null && 
                       hasCompany() && 
                       resource.data.companyId == getUserCompanyId() &&
                       request.resource.data.companyId == getUserCompanyId();
      
      // Solo usuarios con companyId pueden eliminar mediciones de SU empresa
      allow delete: if request.auth != null && 
                       hasCompany() && 
                       resource.data.companyId == getUserCompanyId();
    }

    // Colección de items globales de Tortuga (compartidos entre empresas)
    match /globalTurtleItems/{itemId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Colección de usuarios autorizados (legacy - mantener por compatibilidad)
    match /authorized_users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
